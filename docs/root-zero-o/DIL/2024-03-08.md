

## 2.2 가상 DOM과 리액트 파이버
### DOM과 브라우저 렌더링 과정
#### 브라우저 렌더링
- 주소를 방문해 HTML 파일을 다운로드한다.
- HTML을 파싱해 DOM을 만들고, CSS를 파싱해 CSSOM을 만든다.
- DOM 노드를 순회하며 분석한다.
- 분석한 DOM 노드를 대상으로 해당 노드에 대한 CSSOM 정보를 찾고 발견한 CSS 정보를 노드에 적용한다.
  - 레이아웃 : 화면 어느 좌표에 나타나야 하는지 계산하는 과정
  - 페인팅 : 레이아웃 단계를 거친 노드에 색과 같은 실제 유효한 모습을 그리는 과정
   
#### 가상 DOM의 탄생 배경
- SPA : 하나의 페이지에서 모든 작업이 일어난다. -> 계속해서 요소의 위치를 재계산하기 때문에 비용이 커진다.
- 리액트가 관리하는 가상의 DOM
- 웹페이지가 표시해야 할 DOM을 메모리에 일단 저장 -> 준비 완료됐을 떄 실제 브라우저 DOM에 반영한다.
- 메모리에서 계산하는 과정을 거쳐 렌더링 과정을 최소화 한다.

#### 리액트 파이버
- 개념
  - 리액트에서 관리하는 JS 객체. 파이버 재조정자(fiber reconciler)가 관리한다.  
  - 가상 DOM과 실제 DOM을 비교해 변경 사항을 수집하고, 차이가 있으면 변경과 관련된 정보를 가지고 있는 파이버를 기준으로 화면에 렌더링을 요청한다.
  - 재조정(reconciliation) : 리액트에서 어떤 부분을 새롭게 렌더링 해야하는 지 두 DOM을 비교하는 작업(알고리즘)
- 역할
  - 작업을 작은 단위로 분할하고 쪼갠 뒤, 우선순위를 매긴다.
  - 이러한 작업을 일시 중지하고 나중에 다시 시작할 수 있다.
  - 이전에 했던 작업을 다시 재사용하거나 필요하지 않은 경우에 폐기할 수 있다.
  - 이 모든 과정은 비동기로 일어난다.
- 구성
  - 하나의 작업단위로 구성된다.
  - 리액트는 작업 단위를 하나씩 처리하고 finishedWork()라는 작업으로 마무리한다.
  - 렌더 단계 : 모든 비동기 작업을 수행 + 파이버의 작업, 우선순위를 지정하거나 중지하거나 버린다.
  - 커밋 단계 : DOM에 실제 변경 사항을 반영하는 commitWork()가 실행된다.(동기식, 중단될 수 없다)
- 특징
  - 컴포넌트가 최초로 마운트되는 시점에 생성되어 가급적 재사용된다.
  - 하나의 element에 하나가 생성되는 1:1의 관계 -> 1:1로 매칭된 정보를 가지고 있는 것이 tag
- 속성
  - stateNode : 파이버 자체에 대한 참조. 참조를 바탕으로 리액트는 파이버와 관련된 상태에 접근한다.
  - child, sibling, return
    - 파이버 간의 관계 개념을 나타낸다.
    - 리액트 컴포넌트 트리처럼 파이버도 트리 형식을 가짐 -> 트리 형식을 구성하는 데 필요한 정보가 이 속성 내부에 정의된다.
    - 하나의 child만 존재한다. -> 여러 개면 첫 번째 자식의 참조로 구성된다.
    - ```javascript
      // 구조
      <ul>
        <li>하나</li>
        <li>둘</li>
        <li>셋</li>
      </ul>

      // 파이버
      const l3 = {
        return: ul, // 부모
        index: 2, // 형제 중 순서
      }

      const l2 = {
        sibling: 13,
        return : ul,
        index: 1,
      }

      const l1 = {
        sibling: 12,
        return : ul,
        index: 0
      }

      const ul = {
        //...
        child : l1
      }
      ```
  - index : 여러 sibling 사이에서 자신의 위치가 몇 번째인지
  - pendingProps : 아직 작업을 미처 처리하지 못한 props
  - memoizeProps : pendingProps를 기준으로 렌더링 완료 이후 pendingProps를 memoizedProps로 저장해 관리
  - updateQueue : 상태 업데이트, 콜백 함수, DOM 업데이트 등 필요한 작업을 담아두는 큐
  - memoizedState : 함수 컴포넌트의 훅 목록 저장
  - alternate : 반대편 트리 파이버
> 이렇게 생성된 파이버는 state 변경, 생명주기 메서드 실행, DOM 변경 필요한 시점 등에 실행된다.

> 리액트의 핵심 원칙은 UI를 문자열, 숫자, 배열과 같은 값으로 관리한다는 것이다.

#### 리액트 파이버 트리
- 현재 모습을 담은 파이버 트리 / 작업중인 상태를 나타내는 workInProgress 트리 두 개 존재
- 더블 버퍼링 : 리액트 파이버 작업이 끝나면 단순히 포인터만 변경해 workInProgress 트리를 현재 트리로 바꾼다.(커밋 단계에서 수행)
  - 1. current(UI 렌더링을 위해 존재하는 트리)를 기준으로 작업 시작
  - 2. 업데이트가 발생하면 파이버는 새로운 workInProgress 트리를 빌드한다.
  - 3. 빌드가 끝나면 다음 렌더링에 이 트리를 사용한다.
  - 4. workInProgress 트리가 UI에 렌더링되어 반영 완료되면 current가 workInProgress로 변경된다.

#### 파이버의 작업 순서
- 파이버 노드 생성
  - 1. beginWork() 실행 : 더 이상 자식이 없는 파이버를 만날 때까지 트리 형식으로 시작
  - 2. completeWork() 실행 : 파이버 작업 완료
  - 3. 형제가 있다면 형제로 넘어감
  - 4. 2, 3이 모두 끝나면 return으로 돌아가 완료
- 업데이트가 필요하면 workInProgress 트리를 빌드, 되도록 기존 파이버 업데이트 


